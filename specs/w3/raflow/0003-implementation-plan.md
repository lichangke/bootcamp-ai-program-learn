# RAFlow 实施计划（Implementation Plan）

**文档版本**: v1.0  
**创建日期**: 2026-02-19  
**关联规格**: `specs/w3/raflow/0001-spec.md`  
**关联设计**: `specs/w3/raflow/0002-design.md`  
**目标产物**: `specs/w3/raflow/0003-implementation-plan.md`

## 1. 实施目标

在 `0002-design.md` 的技术方案基础上，完成 RAFlow 的首个可交付版本（MVP），实现端到端闭环：

1. 用户按下全局热键后开始录音，并建立/复用 WebSocket 连接。
2. 音频完成采集、重采样、编码后流式发送到 ElevenLabs Scribe。
3. 收到 `partial_transcript` 时实时更新悬浮窗内容。
4. 收到 `committed_transcript` 时执行文本注入（键盘模拟或剪贴板注入）。
5. 支持系统托盘、设置面板、基础权限检查、错误提示和日志。

## 2. 范围定义

## 2.1 In Scope（本期交付）

1. Tauri v2 项目骨架与跨平台运行（Windows/macOS/Linux）。
2. Rust 核心模块：音频采集、音频处理、网络通信、输入注入。
3. 全局热键、托盘菜单、悬浮窗 UI、设置页（最小可用版本）。
4. API Key 安全存储（Keyring/Keychain）与读取。
5. 基础可观测性：日志、关键错误上报接口预留。
6. 单元测试、关键集成测试、最小端到端冒烟路径。

## 2.2 Out of Scope（后续迭代）

1. 本地离线转写（Whisper 等）。
2. 复杂上下文感知 Prompt（按 App/窗口深度定制）。
3. 高级音频优化（SIMD、对象池全量优化）。
4. 全量多语言 UI 与完整国际化。

## 3. 工程结构与模块映射

按 `0002-design.md` 中建议目录落地：

```text
specs/w3/raflow/
├── 0001-spec.md
├── 0002-design.md
└── 0003-implementation-plan.md

w3/raflow/
├── src/                         # 前端
│   ├── App.tsx
│   ├── main.tsx
│   └── components/
│       ├── OverlayWindow.tsx
│       └── SettingsPanel.tsx
├── src-tauri/                   # Rust 后端
│   ├── Cargo.toml
│   ├── tauri.conf.json
│   ├── capabilities/default.json
│   └── src/
│       ├── main.rs
│       ├── lib.rs
│       ├── commands.rs
│       ├── audio/
│       │   ├── mod.rs
│       │   ├── capturer.rs
│       │   └── resampler.rs
│       ├── network/
│       │   ├── mod.rs
│       │   └── scribe_client.rs
│       └── input/
│           ├── mod.rs
│           └── injector.rs
└── tests/
```

模块责任归属：

1. `audio/*`: 设备选择、采集、缓冲、重采样。
2. `network/*`: WebSocket 握手、鉴权、音频上行、事件下行。
3. `input/*`: 文本注入策略（短文本键盘、长文本剪贴板）。
4. `commands.rs`: Tauri 命令和前后端桥接。
5. `components/*`: 实时状态可视化、设置与错误反馈。

## 4. 实施原则

1. 先打通主链路，再完善体验: 热键 -> 录音 -> 转写 -> 注入必须先可用。
2. 实时线程最小化: 音频回调内只做轻量操作，避免阻塞。
3. 契约优先: 先稳定 WebSocket 消息结构，再做 UI 细节。
4. 可回滚/可降级: 注入失败要可提示，网络抖动要可重连。
5. 每阶段必须有可验证产物与验收标准。

## 5. 总体排期（建议 15 个工作日）

建议启动日: **2026-02-23（周一）**  
建议完成日: **2026-03-13（周五）**

1. Phase 0（2026-02-23 ~ 2026-02-24）: 项目基线与脚手架。
2. Phase 1（2026-02-25 ~ 2026-02-27）: 音频采集与处理链路。
3. Phase 2（2026-03-02 ~ 2026-03-04）: 网络通信与转写事件闭环。
4. Phase 3（2026-03-05 ~ 2026-03-06）: 输入注入与系统交互。
5. Phase 4（2026-03-09 ~ 2026-03-10）: 前端 UI 与状态管理。
6. Phase 5（2026-03-11 ~ 2026-03-12）: 稳定性、安全、性能优化。
7. Phase 6（2026-03-13）: 测试冻结与发布准备。

## 6. 分阶段详细计划

## Phase 0（2026-02-23 ~ 2026-02-24）项目基线

目标: 建立可运行的 Tauri v2 基础工程，完成依赖与权限基线。

任务清单:

1. 初始化 `./w3/raflow` 工程，确认前后端目录结构。
2. 配置 `Cargo.toml` 依赖（tauri/tokio/cpal/rubato/ws/enigo/serde 等）。
3. 配置 `tauri.conf.json` 与 `capabilities/default.json` 最小权限集。
4. 建立基础命令通道（`commands.rs`）与前端调用骨架。
5. 接入日志初始化（`tracing`）与错误类型骨架（`thiserror`）。

交付物:

1. 本地可执行 `npm run tauri dev`。
2. 主窗口 + 托盘可见，关闭窗口改为隐藏。
3. 基础命令调用可验证（前端可触发后端 ping/status 命令）。

验收标准:

1. 三平台至少完成 1 个主开发平台联调（建议先 Windows）。
2. 所有基础依赖可编译通过。
3. 权限声明与设计文档一致。

## Phase 1（2026-02-25 ~ 2026-02-27）音频链路

目标: 打通本地音频采集到重采样输出（不含网络发送）。

任务清单:

1. 实现 `audio/capturer.rs`: 设备选择、流初始化、Ring Buffer 写入。
2. 实现 `audio/resampler.rs`: 48kHz -> 16kHz 重采样与 `f32 -> i16` 转换。
3. 实现音频处理异步任务：批量读取、100ms 分块、输出通道。
4. 增加模块级错误处理：设备不存在、流初始化失败、缓冲区溢出。
5. 编写单元测试：重采样长度、格式转换边界、异常输入。

交付物:

1. 音频采集/处理日志可见（每块时间戳、块大小、采样率信息）。
2. 本地验证 5 秒录音可持续产生 16k PCM 数据块。

验收标准:

1. 连续运行 5 分钟无崩溃。
2. 数据块节奏稳定（100ms 目标，允许小幅抖动）。
3. 核心单元测试通过。

## Phase 2（2026-03-02 ~ 2026-03-04）网络与转写闭环

目标: 打通音频上行与转写事件下行，完成转写事件分发。

任务清单:

1. 实现 `network/scribe_client.rs`: 连接、鉴权、消息发送、消息接收。
2. 定义协议结构：`input_audio_chunk`、`partial_transcript`、`committed_transcript`。
3. 增加连接生命周期管理：连接复用、超时重建、断线重连。
4. 增加事件总线/分发机制：将 `partial` 和 `committed` 推送给 UI/注入模块。
5. 打通热键触发流程：按下开始录音，释放结束并 flush。

交付物:

1. 可收到实时 `partial_transcript` 并输出日志。
2. 可收到 `committed_transcript` 并进入注入模块待处理队列。

验收标准:

1. 使用有效 API Key 可稳定建立会话并返回 `session_started`。
2. 无效 Key 错误可被捕获并可视化提示。
3. 网络异常可自动恢复或提示用户重试。

## Phase 3（2026-03-05 ~ 2026-03-06）输入注入与系统交互

目标: 实现可控、安全的文本注入策略。

任务清单:

1. 实现 `input/injector.rs` 注入器。
2. 注入策略: 文本长度 `< 10` 使用键盘模拟，`>= 10` 使用剪贴板粘贴。
3. 剪贴板保护: 读取旧内容、写入新内容、粘贴后恢复旧内容。
4. 平台快捷键适配：macOS `Cmd+V`，其他平台 `Ctrl+V`。
5. 输入文本校验：长度上限、控制字符过滤、恶意模式过滤。

交付物:

1. 在记事本/文本编辑器中可稳定注入 committed 文本。
2. 注入失败可见错误日志与用户提示。

验收标准:

1. 100 次注入成功率达到 99% 以上（开发环境冒烟）。
2. 剪贴板恢复逻辑在主流场景可用。
3. 失败路径不会导致应用卡死或崩溃。

## Phase 4（2026-03-09 ~ 2026-03-10）前端 UI 与交互

目标: 构建 MVP 可用界面，完成实时反馈与设置管理。

任务清单:

1. 实现 `OverlayWindow.tsx`：状态（Listening/Recording/Processing/Injecting/Error）与 partial 文本展示。
2. 实现 `SettingsPanel.tsx`：API Key、语言、热键、注入阈值等基础配置。
3. 前后端 IPC 事件绑定：状态推送、错误推送、配置读写。
4. 托盘菜单动作：打开设置、显示/隐藏悬浮窗、退出。
5. UI 边界态处理：空文本、断网、权限不足、鉴权失败。

交付物:

1. 用户可在 UI 完成配置并立即生效。
2. 录音中可实时看到 partial 文本。

验收标准:

1. 主流程用户可无命令行完成配置和使用。
2. 错误反馈可理解且可恢复。
3. 基础交互无阻塞问题。

## Phase 5（2026-03-11 ~ 2026-03-12）稳定性、安全、性能

目标: 将 MVP 从“可用”提升到“可发布内测”。

任务清单:

1. 增加连接池/连接复用策略与闲置超时释放。
2. 增加批量发送与背压策略，控制网络抖动影响。
3. 增加关键指标采集：端到端延迟、块处理耗时、注入耗时。
4. 增加权限检查（麦克风、辅助功能）和用户引导。
5. 完善 API Key 安全存储与异常保护。

交付物:

1. 性能监控日志与简版报告。
2. 风险清单收敛版（已关闭/遗留项）。

验收标准:

1. 端到端 P95 延迟目标 `< 500ms`（开发环境语音到注入）。
2. 连续运行 30 分钟无内存异常增长。
3. 关键安全项（Key 存储、输入校验）完成。

## Phase 6（2026-03-13）测试冻结与发布准备

目标: 完成验收闸门，产出可交付构建。

任务清单:

1. 运行单元测试、集成测试、端到端冒烟测试。
2. 修复阻断级缺陷（P0/P1）。
3. 更新部署文档（构建、签名、打包）。
4. 生成发布候选包（RC）并完成安装验证。

交付物:

1. RC 包（至少 1 个平台）。
2. 验收记录与遗留问题列表。

验收标准:

1. 主流程通过率 100%。
2. 阻断级缺陷为 0。
3. 文档与产物一致可复现。

## 7. 关键路径与依赖

1. Phase 0 未完成，后续阶段全部阻塞。
2. Phase 1 音频链路不稳定，Phase 2 网络流式无法验证。
3. Phase 2 未形成 committed 事件，Phase 3 注入无法联调。
4. Phase 3 注入未稳定，Phase 4 UI 仅能演示不可验收。
5. Phase 5 优化未完成，不进入最终发布。

关键路径:

1. 脚手架 -> 音频链路 -> 网络转写 -> 文本注入 -> UI 联调 -> 稳定性优化 -> 测试冻结。

## 8. 风险与预案

1. 音频回调阻塞导致丢帧。
   - 预案: 回调内只写 Ring Buffer，编码与网络发送全部异步化。
2. 第三方 API 波动导致体验不稳定。
   - 预案: 重连机制 + 明确状态提示 + 本地重试退避。
3. 跨平台注入行为差异。
   - 预案: 平台分支实现 + 注入失败回退到剪贴板模式。
4. 权限问题导致功能不可用。
   - 预案: 首次启动权限检查与引导说明。
5. 剪贴板恢复失败引发用户数据风险。
   - 预案: 增加异常保护与恢复失败提示，保留审计日志。

## 9. 质量闸门（Go/No-Go）

进入交付前必须满足：

1. 功能闸门:
   - 热键触发录音与转写可用。
   - partial 显示与 committed 注入可用。
2. 质量闸门:
   - 单元测试与关键集成测试通过。
   - P0/P1 缺陷为 0。
3. 性能闸门:
   - 端到端延迟达到目标区间。
4. 安全闸门:
   - API Key 安全存储可用。
   - 输入校验与权限检查已启用。

## 10. 任务分解清单（WBS）

1. WBS-01: Tauri 工程初始化与依赖安装。
2. WBS-02: 权限与托盘/热键基础功能。
3. WBS-03: 音频采集模块实现。
4. WBS-04: 重采样与编码模块实现。
5. WBS-05: WebSocket 客户端与协议适配。
6. WBS-06: 事件分发与状态机驱动。
7. WBS-07: 文本注入策略与剪贴板保护。
8. WBS-08: 悬浮窗与设置 UI。
9. WBS-09: 配置持久化与密钥安全存储。
10. WBS-10: 测试体系与质量门禁。
11. WBS-11: 打包签名与发布流水线。

## 11. 每日同步机制（执行建议）

1. 09:30 站会: 目标、阻塞、依赖。
2. 12:00 中间检查: 完成度、风险状态。
3. 18:00 收工同步: 当日产物、明日计划。

同步模板：

```md
日期: YYYY-MM-DD
阶段: Phase X
计划任务:
- [ ] 任务 A
- [ ] 任务 B

实际完成:
- 已完成:
- 未完成:

阻塞项:
- 描述:
- 影响:
- 处理人:
- 预计恢复时间:

风险变化:
- 新增:
- 关闭:

明日计划:
- 任务 1
- 任务 2
```

## 12. 完成定义（Definition of Done）

1. 用户无需命令行可完成配置并使用主流程。
2. 从热键触发到 committed 文本注入形成稳定闭环。
3. 核心测试集与验收清单全部通过。
4. 文档、配置、构建脚本与实际实现一致。
5. 形成下一迭代 backlog（本地 VAD、离线模式、多语言增强）。
