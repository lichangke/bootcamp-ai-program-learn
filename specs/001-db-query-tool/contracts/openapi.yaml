openapi: 3.1.0
info:
  title: DB Query Tool API
  version: 0.1.0
  description: |
    API for managing PostgreSQL connections, schema metadata, SQL querying,
    and natural-language-to-SQL generation.
servers:
  - url: http://localhost:8000
tags:
  - name: Databases
  - name: Query
paths:
  /api/v1/dbs:
    get:
      tags: [Databases]
      summary: List stored databases
      operationId: listDatabases
      responses:
        '200':
          description: Stored database connections
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DbConnectionSummary'
                required: [items]
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/dbs/{name}:
    parameters:
      - $ref: '#/components/parameters/DbName'
    put:
      tags: [Databases]
      summary: Add or update a database connection
      operationId: upsertDatabase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PutDbRequest'
      responses:
        '200':
          description: Connection validated and stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DbConnectionDetail'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '422':
          $ref: '#/components/responses/ErrorResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

    get:
      tags: [Databases]
      summary: Get one database metadata
      operationId: getDatabase
      responses:
        '200':
          description: Database connection and latest metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DbConnectionDetail'
        '404':
          $ref: '#/components/responses/ErrorResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/dbs/{name}/query:
    parameters:
      - $ref: '#/components/parameters/DbName'
    post:
      tags: [Query]
      summary: Execute read-only SQL query
      operationId: executeSqlQuery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SqlQueryRequest'
      responses:
        '200':
          description: Query executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '422':
          $ref: '#/components/responses/ErrorResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/dbs/{name}/query/natural:
    parameters:
      - $ref: '#/components/parameters/DbName'
    post:
      tags: [Query]
      summary: Generate SQL from natural language
      operationId: generateNaturalSql
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NaturalQueryRequest'
      responses:
        '200':
          description: SQL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NaturalQueryResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '422':
          $ref: '#/components/responses/ErrorResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

components:
  parameters:
    DbName:
      name: name
      in: path
      required: true
      schema:
        type: string
        pattern: '^[a-zA-Z0-9_-]{1,64}$'

  responses:
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    PutDbRequest:
      type: object
      properties:
        url:
          type: string
          description: PostgreSQL connection URL
          example: postgres://postgres:postgres@localhost:5432/postgres
      required: [url]

    DbConnectionSummary:
      type: object
      properties:
        name:
          type: string
        dialect:
          type: string
          enum: [postgres]
        isReachable:
          type: boolean
        lastCheckedAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
      required: [name, dialect, isReachable, updatedAt]

    ColumnMetadata:
      type: object
      properties:
        name:
          type: string
        dataType:
          type: string
        nullable:
          type: boolean
      required: [name, dataType, nullable]

    TableMetadata:
      type: object
      properties:
        schema:
          type: string
        name:
          type: string
        kind:
          type: string
          enum: [table, view]
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMetadata'
      required: [schema, name, kind, columns]

    SchemaMetadata:
      type: object
      properties:
        version:
          type: integer
          minimum: 1
        sourceCapturedAt:
          type: string
          format: date-time
        normalizedAt:
          type: string
          format: date-time
        tables:
          type: array
          items:
            $ref: '#/components/schemas/TableMetadata'
        views:
          type: array
          items:
            $ref: '#/components/schemas/TableMetadata'
      required: [version, sourceCapturedAt, normalizedAt, tables, views]

    DbConnectionDetail:
      allOf:
        - $ref: '#/components/schemas/DbConnectionSummary'
        - type: object
          properties:
            metadata:
              $ref: '#/components/schemas/SchemaMetadata'
          required: [metadata]

    SqlQueryRequest:
      type: object
      properties:
        sql:
          type: string
      required: [sql]

    QueryResponse:
      type: object
      properties:
        executedSql:
          type: string
        columns:
          type: array
          items:
            type: string
        rows:
          type: array
          items:
            type: array
            items: {}
        rowCount:
          type: integer
          minimum: 0
        durationMs:
          type: integer
          minimum: 0
        truncated:
          type: boolean
      required: [executedSql, columns, rows, rowCount, durationMs, truncated]

    NaturalQueryRequest:
      type: object
      properties:
        prompt:
          type: string
      required: [prompt]

    NaturalQueryResponse:
      type: object
      properties:
        sql:
          type: string
        notes:
          type: string
          nullable: true
      required: [sql]

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true
              nullable: true
            requestId:
              type: string
              nullable: true
          required: [code, message]
      required: [error]
